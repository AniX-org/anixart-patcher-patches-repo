{# templates/patches.html - Jinja2 template for patches repo #}
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{{ repo.title | e }} â€” Patches</title>

    <!-- Bootstrap 5 (CDN) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg: #0f1114;
        --card: #17181a;
        --muted: #9aa3ad;
      }
      body {
        background: var(--bg);
        color: #e6eef6;
      }
      .card {
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.03);
      }
      a {
        color: #8fd3ff;
      }
      .tag {
        font-size: 0.8rem;
        padding: 0.18rem 0.5rem;
        border-radius: 0.35rem;
        background: rgba(255, 255, 255, 0.03);
      }
      .small-muted {
        color: var(--muted);
      }
      .search-input {
        max-width: 720px;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <!-- Header -->
      <header class="text-center mb-4">
        <h1 class="h3 mb-1">{{ repo.title | e }}</h1>
        <p class="mb-1">
          <a href="{{ repo.url | e }}" target="_blank" rel="noopener noreferrer"
            >{{ repo.url | e }}</a
          >
        </p>
        <p class="mt-2">
          Maintainer:
          <a
            href="{{ maintainer.url | e }}"
            target="_blank"
            rel="noopener noreferrer"
            >{{ maintainer.maintainer | e }}</a
          >
        </p>
      </header>

      <!-- Search / Filters -->
      <div class="mb-4 text-center">
        <input
          id="search"
          class="form-control search-input"
          placeholder="Search patches by title, filename, author or tag..."
          aria-label="Search patches"
        />
        <div class="form-text small-muted mt-1">
          Type to filter. Filters client-side for fast browsing.
        </div>
      </div>

      <!-- Patches grid -->
      <div id="patches" class="row g-4">
        {%- for p in patches %}
        <div
          class="col-12 col-md-6 patch-item"
          data-title="{{ p.title | e | lower }}"
          data-filename="{{ p.filename | e | lower }}"
          data-author="{{ p.author | e | lower }}"
          data-tags="{{ (p.tags | join(' ')) | e | lower }}"
        >
          <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column">
              <div
                class="d-flex justify-content-between align-items-start mb-2"
              >
                <div>
                  <h5 class="card-title mb-0">{{ p.title | e }}</h5>
                  <div class="card-subtitle small-muted">
                    {{ p.filename | e }}
                  </div>
                </div>
                <div class="text-end small-muted">
                  <div class="card-subtitle">v{{ p.version | e }}</div>
                  <div class="card-subtitle">
                    priority: {{ p.priority | default(0) }}
                  </div>
                </div>
              </div>

              <p class="card-text mb-2">{{ p.description | e }}</p>

              <ul class="list-unstyled small small-muted mb-3">
                <li>
                  <strong class="text-light">Author:</strong> {{ p.author | e }}
                </li>
                <li>
                  <strong class="text-light">Created:</strong> {{ p.initDate |
                  convert_datetime | e }}
                </li>
                <li>
                  <strong class="text-light">Modified:</strong> {{ p.modDate |
                  convert_datetime | e }}
                </li>
                <li>
                  <strong class="text-light">SHA256:</strong>
                  <code class="small">{{ p.sha256 | e }}</code>
                </li>
              </ul>

              <div
                class="mt-auto d-flex justify-content-between align-items-center"
              >
                <div>
                  {%- for t in p.tags %}
                  <span class="tag me-1">{{ t | e }}</span>
                  {%- endfor %}
                </div>
                <div>
                  {%- if p.readme %}
                  <a
                    class="btn btn-sm btn-outline-light"
                    href="{{ p.readme | e }}"
                    target="_blank"
                    rel="noopener noreferrer"
                    >Readme</a
                  >
                  {%- endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        {%- else %}
        <div class="col-12">
          <div class="alert alert-secondary" role="alert">
            No patches found in this repository.
          </div>
        </div>
        {%- endfor %}
      </div>
    </div>

    <!-- Bootstrap + small client-side filter script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      (function () {
        const input = document.getElementById("search");
        const items = Array.from(document.querySelectorAll(".patch-item"));

        function normalize(s) {
          return (s || "").toString().trim().toLowerCase();
        }

        input.addEventListener("input", () => {
          const q = normalize(input.value);
          if (!q) {
            items.forEach((it) => (it.style.display = ""));
            return;
          }

          const terms = q.split(/\s+/).filter(Boolean);
          items.forEach((it) => {
            const hay = [
              it.dataset.title || "",
              it.dataset.filename || "",
              it.dataset.author || "",
              it.dataset.tags || "",
            ].join(" ");
            const haynorm = normalize(hay);
            // require all terms to be present
            const visible = terms.every((t) => haynorm.indexOf(t) !== -1);
            it.style.display = visible ? "" : "none";
          });
        });
      })();
    </script>
  </body>
</html>
